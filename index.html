<html>
<body>
<h1>Challenge Tracker</h1>

<table id="challengeList">

    <thead>
    <tr id="challengeListHeader">
        <th>
            Challenge Description
        </th>
    </tr>
    </thead>

    <tbody id="challengeListBody">

    </tbody>

</table>


<button id="initialize" style="display: none">Initialize Challenges</button>
<button id="add-challenge">Add new Challenge</button>
<button id="add-user">Add new User</button>


<script src="https://www.gstatic.com/firebasejs/5.9.0/firebase.js"></script>
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyComvDhjmTxZV6s07x7hxOCgnB0D9OxTWk",
        authDomain: "challenge-tracker-h-block.firebaseapp.com",
        databaseURL: "https://challenge-tracker-h-block.firebaseio.com",
        projectId: "challenge-tracker-h-block",
        storageBucket: "challenge-tracker-h-block.appspot.com",
        messagingSenderId: "497930259522"
    };
    firebase.initializeApp(config);

    var database = firebase.database();

    // Add a new challenge to the database
    document.getElementById("add-challenge").onclick = function () {
        var challenge = prompt("What should be the challenge?", "");

        if (challenge == null || challenge === "") {
        } else {
            var reference = database.ref('challenges');

            reference.push().set(challenge)
                .then(function (snapshot) {
                }, function (error) {
                    console.log('error' + error);
                });
        }

        location.reload()
    };

    // Add a new user to the database
    document.getElementById("add-user").onclick = function () {
        var userName = prompt("What is your name?", "");

        if (userName == null || userName === "") {
        } else {

            var reference = database.ref('users');

            var user = {
                name: userName,
                completedChallenges: []
            };

            reference.push().set(user)
                .then(function (snapshot) {
                }, function (error) {
                    console.log('error' + error);
                });
        }

        location.reload()
    };

    // Display all available challenges
    database.ref('users').once('value')
        .then(function (userSnapshot) {

            var userMap = userSnapshot.val();

            var users = [];

            if (userMap !== undefined && userMap !== null) {
                Object.keys(userMap).forEach(function (key) {
                    var user = userMap[key];

                    var challengesListHeader = document.getElementById("challengeListHeader");

                    var userCell = document.createElement("th");
                    userCell.appendChild(document.createTextNode(user.name));
                    challengesListHeader.appendChild(userCell);

                    users.push({
                        id: key,
                        name: user.name,
                        completedChallenges: user.completedChallenges
                    });
                });
            }

            // Display all available challenges
            database.ref('challenges').once('value')
                .then(function (challengeSnapshot) {

                    var challengeMap = challengeSnapshot.val();

                    if (challengeMap !== undefined && challengeMap !== null) {
                        Object.keys(challengeMap).forEach(function (key) {
                            var challenge = challengeMap[key];

                            var challengesListBody = document.getElementById("challengeListBody");

                            var row = document.createElement("tr");
                            var descriptionCell = document.createElement("td");
                            descriptionCell.appendChild(document.createTextNode(challenge));
                            row.appendChild(descriptionCell);
                            
                            users.forEach(function (user) {
                                var userSpecificCell = document.createElement("td");
                                var completedChallenges = user.completedChallenges;
                                if (completedChallenges !== undefined && completedChallenges.indexOf(key) !== -1) {
                                    userSpecificCell.appendChild(document.createTextNode("\u2713ss"))
                                } else {
                                    var checkChallenge = document.createElement("button");
                                    checkChallenge.onclick = function () {

                                        var completed = [];
                                        if (user.completedChallenges !== undefined && user.completedChallenges !== null) {
                                            user.completedChallenges.forEach(function (value) {
                                                completed.push(value);
                                            });
                                        }

                                        completed.push(key);
                                        database.ref('users/' + user.id).update({completedChallenges: completed})

                                        location.reload()
                                    };
                                    checkChallenge.innerHTML = "Check Challenge";
                                    userSpecificCell.appendChild(checkChallenge);
                                }
                                row.appendChild(userSpecificCell);
                            });
                            
                            challengesListBody.appendChild(row);
                        });
                    }
                });
        });


</script>
</body>
</html>
